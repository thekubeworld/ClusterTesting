name: "sonobuoy tests"
on:
  workflow_dispatch:
  schedule:
    # Daily, 3:00pm
    - cron: '00 15 * * *'

jobs:
  sonobuoy-tests:
    runs-on: [ ubuntu-18.04 ]
    env:
      GOPATH: /home/runner/work/k8devel/go
      GO111MODULE: auto
    steps:
      - uses: actions/checkout@v2
        with:
           path: main

        # Setup Go
      - name: Setup Go
        uses: actions/setup-go@v2
        with:
          go-version: '1.16.x'
      - uses: actions/checkout@master
        with:
          repository: thekubeworld/k8s-local-dev
          path: k8s-local-dev
      - run: |
          pushd ./k8s-local-dev
            ANTREA_VERSION=v1.0.1 ./k8s-local-dev antrea
          popd
          sudo apt update
          sudo apt install wget -y
          wget https://github.com/vmware-tanzu/sonobuoy/releases/download/v0.50.0/sonobuoy_0.50.0_linux_amd64.tar.gz
          sudo tar zxvf sonobuoy_0.50.0_linux_amd64.tar.gz -C /bin
          sonobuoy run --mode=Quick --wait
          #sonobuoy run --mode=certified-conformance --wait
      - name: Commit files
        id: commit
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "github-actions"
          outfile=$(sonobuoy retrieve)
          sonobuoy results $outfile
          mkdir kind-iptables-conf-$(date +"%m-%d-%Y-%k:%M:%S")/
          mv $outfile kind-iptables-conf*
          git add kind-iptables-conf*/$outfile
          if [-z "$(git status --porcelain)"]; then
             echo "::set-output name=push::false"
          else
             git commit -m "Add output from sonobuoy tests" -a
             echo "::set-output name=push::true"
          fi
        shell: bash
      - name: Push changes
        if: steps.commit.outputs.push == 'true'
        uses: ad-m/github-push-action@master
        with:
           github_token: ${{ secrets.GITHUB_TOKEN }}
